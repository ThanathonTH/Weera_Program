"""
‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó
‚ïë                  INFINITY MP3 DOWNLOADER v4.0                                ‚ïë
‚ïë                 Main Application (CustomTkinter GUI)                          ‚ïë
‚ï†‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï£
‚ïë  üöÄ Package-Based Architecture                                                ‚ïë
‚ïë  üîå Decoupled Download Engine with Performance Optimizations                  ‚ïë
‚ïë  üåê Thai Keyboard Support (Hardware Keycode Bindings)                         ‚ïë
‚ïë  üé® High-Precision Progress Bar (Floating Point)                             ‚ïë
‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù
"""

import os
import sys
import ctypes
from datetime import datetime
from tkinter import filedialog, messagebox
from typing import Optional

import customtkinter as ctk

from src.utils.paths import (
    BASE_DIR,
    ENGINE_DIR,
    YTDLP_PATH,
    FFMPEG_PATH,
    APP_VERSION,
    UPDATE_JSON_URL,
    is_frozen,
    get_icon_path,
)
from src.utils.fonts import FontLoader
from src.core.settings import SettingsManager
from src.core.downloader import Downloader, run_in_thread
from src.core.updater import run_full_update_routine
from src.ui.dialogs import FirstRunPathDialog, DependencySetupDialog
from src.ui.widgets import create_context_menu


# Set UI Theme
ctk.set_appearance_mode("dark")
ctk.set_default_color_theme("blue")


class InfinityMP3Downloader(ctk.CTk):
    """
    Infinity MP3 Downloader v4.0
    
    Main application window with modular architecture.
    
    Features:
    - High-Performance Download Engine (concurrent fragments)
    - Decoupled GUI/Logic design
    - Thai keyboard support
    - Intelligent path management
    """
    
    def __init__(self):
        super().__init__()
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # STEP 1: Load fonts after root window creation
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        self.font_family, self.is_custom_font = FontLoader.load()
        self._setup_fonts()
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # STEP 2: Load settings and sync checkbox state
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        settings = SettingsManager.load()
        self.output_dir: str = settings.get("download_path", "")
        self._path_is_saved: bool = bool(self.output_dir)
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # STEP 3: Window configuration
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        self.title(f"‚àû Infinity MP3 Downloader v{APP_VERSION}")
        self.geometry("780x550")
        self.minsize(720, 450)
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # STEP 4: App Icon (Taskbar Fix for Windows)
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        try:
            myappid = f'weera.infinity.downloader.v{APP_VERSION}'
            ctypes.windll.shell32.SetCurrentProcessExplicitAppUserModelID(myappid)
            print(f"‚úÖ Taskbar ID set: {myappid}")
        except Exception as e:
            print(f"‚ö†Ô∏è Failed to set taskbar ID: {e}")
        
        icon_path = get_icon_path()
        if icon_path:
            try:
                self.iconbitmap(icon_path)
                print(f"‚úÖ App icon loaded: {icon_path}")
            except Exception as e:
                print(f"‚ö†Ô∏è Failed to load icon: {e}")
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # STEP 5: State variables
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        self.is_downloading: bool = False
        self.is_updating: bool = False
        self.downloader: Optional[Downloader] = None
        self.log_visible: bool = False
        
        # Build UI and start
        self._build_ui()
        self.after(200, self._startup_sequence)
    
    def _setup_fonts(self) -> None:
        """Configure font tuples based on loaded font family."""
        ff = self.font_family
        if self.is_custom_font:
            self.FONT_NORMAL = (ff, 18)
            self.FONT_BOLD = (ff, 18, "bold")
            self.FONT_HEADER = (ff, 26, "bold")
            self.FONT_SUBTITLE = (ff, 15)
            self.FONT_SMALL = (ff, 14)
        else:
            self.FONT_NORMAL = (ff, 14)
            self.FONT_BOLD = (ff, 14, "bold")
            self.FONT_HEADER = (ff, 22, "bold")
            self.FONT_SUBTITLE = (ff, 12)
            self.FONT_SMALL = (ff, 11)
        self.FONT_LOG = ("Consolas", 12)
    
    def _build_ui(self) -> None:
        """Build the main application UI."""
        self.grid_columnconfigure(0, weight=1)
        self.grid_rowconfigure(3, weight=0)
        self.grid_rowconfigure(4, weight=1)
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # 1. HEADER
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        header = ctk.CTkFrame(self, fg_color="transparent")
        header.grid(row=0, column=0, padx=25, pady=(20, 15), sticky="ew")
        
        title = ctk.CTkLabel(
            header,
            text="‚àû Infinity MP3 Downloader",
            font=ctk.CTkFont(family=self.font_family, size=26, weight="bold")
        )
        title.pack(anchor="w")
        
        version = ctk.CTkLabel(
            header,
            text=f"v{APP_VERSION} ‚Ä¢ ‡∏£‡∏∞‡∏ö‡∏ö‡πÅ‡∏õ‡∏•‡∏á YouTube ‡πÄ‡∏õ‡πá‡∏ô MP3 (Optimized)",
            font=self.FONT_SMALL,
            text_color="#777777"
        )
        version.pack(anchor="w")
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # 2. INPUT SECTION (URL + Buttons)
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        input_section = ctk.CTkFrame(self)
        input_section.grid(row=1, column=0, padx=25, pady=10, sticky="ew")
        input_section.grid_columnconfigure(0, weight=1)
        
        url_label = ctk.CTkLabel(
            input_section,
            text="üîó ‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube:",
            font=self.FONT_BOLD
        )
        url_label.grid(row=0, column=0, padx=15, pady=(15, 5), sticky="w")
        
        self.url_entry = ctk.CTkEntry(
            input_section,
            placeholder_text="https://www.youtube.com/watch?v=...",
            height=48,
            font=self.FONT_NORMAL,
            corner_radius=8
        )
        self.url_entry.grid(row=1, column=0, padx=15, sticky="ew")
        
        # Add context menu with Thai keyboard support
        create_context_menu(self.url_entry, font=self.FONT_NORMAL)
        
        # Buttons row
        btn_row = ctk.CTkFrame(input_section, fg_color="transparent")
        btn_row.grid(row=2, column=0, padx=10, pady=15, sticky="ew")
        btn_row.grid_columnconfigure((0, 1, 2), weight=1)
        
        self.download_btn = ctk.CTkButton(
            btn_row,
            text="‚¨áÔ∏è  ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î MP3",
            command=self._on_download,
            height=52,
            font=self.FONT_BOLD,
            fg_color="#22C55E",
            hover_color="#16A34A",
            corner_radius=10
        )
        self.download_btn.grid(row=0, column=0, padx=5, sticky="ew")
        
        self.update_btn = ctk.CTkButton(
            btn_row,
            text="üîÑ ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï",
            command=self._on_update,
            height=52,
            font=self.FONT_NORMAL,
            fg_color="#3B82F6",
            hover_color="#2563EB",
            corner_radius=10
        )
        self.update_btn.grid(row=0, column=1, padx=5, sticky="ew")
        
        self.stop_btn = ctk.CTkButton(
            btn_row,
            text="‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î",
            command=self._on_stop,
            height=52,
            font=self.FONT_NORMAL,
            fg_color="#DC2626",
            hover_color="#B91C1C",
            corner_radius=10,
            state="disabled"
        )
        self.stop_btn.grid(row=0, column=2, padx=5, sticky="ew")
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # 3. CONFIG SECTION (Path + Save Checkbox)
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        config_section = ctk.CTkFrame(self)
        config_section.grid(row=2, column=0, padx=25, pady=(5, 10), sticky="ew")
        config_section.grid_columnconfigure(1, weight=1)
        
        path_label = ctk.CTkLabel(
            config_section,
            text="üìÅ ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå:",
            font=self.FONT_BOLD
        )
        path_label.grid(row=0, column=0, padx=15, pady=12, sticky="w")
        
        self.path_display = ctk.CTkEntry(
            config_section,
            height=40,
            font=self.FONT_NORMAL,
            state="readonly",
            fg_color="#1e1e2f",
            corner_radius=6
        )
        self.path_display.grid(row=0, column=1, padx=(0, 10), pady=12, sticky="ew")
        
        browse_btn = ctk.CTkButton(
            config_section,
            text="‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô",
            command=self._browse_folder,
            width=80,
            height=40,
            font=self.FONT_SMALL,
            fg_color="transparent",
            hover_color="#374151",
            border_width=1,
            corner_radius=6
        )
        browse_btn.grid(row=0, column=2, padx=(0, 10), pady=12)
        
        # Save checkbox - synced with _path_is_saved
        self.save_default_var = ctk.BooleanVar(value=self._path_is_saved)
        self.save_checkbox = ctk.CTkCheckBox(
            config_section,
            text="üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô",
            variable=self.save_default_var,
            font=self.FONT_SMALL,
            command=self._on_save_checkbox_toggle
        )
        self.save_checkbox.grid(row=0, column=3, padx=(5, 15), pady=12)
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # 4. PROGRESS SECTION (Initially hidden)
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        self.progress_frame = ctk.CTkFrame(self, fg_color="transparent")
        
        self.progress_label = ctk.CTkLabel(
            self.progress_frame,
            text="‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô",
            font=self.FONT_BOLD
        )
        self.progress_label.pack(side="left", padx=(0, 15))
        
        self.progress_bar = ctk.CTkProgressBar(
            self.progress_frame,
            height=14,
            corner_radius=7
        )
        self.progress_bar.pack(side="left", expand=True, fill="x", padx=(0, 15))
        self.progress_bar.set(0)
        
        self.progress_pct = ctk.CTkLabel(
            self.progress_frame,
            text="",
            font=self.FONT_BOLD,
            text_color="#22C55E",
            width=70
        )
        self.progress_pct.pack(side="right")
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # 5. LOG SECTION (Collapsible)
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        self.log_container = ctk.CTkFrame(self)
        
        log_header = ctk.CTkFrame(self.log_container, fg_color="transparent")
        log_header.pack(fill="x", padx=15, pady=(12, 5))
        
        log_title = ctk.CTkLabel(
            log_header,
            text="üìã ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô",
            font=self.FONT_BOLD
        )
        log_title.pack(side="left")
        
        self.log_textbox = ctk.CTkTextbox(
            self.log_container,
            font=self.FONT_LOG,
            wrap="word",
            corner_radius=8
        )
        self.log_textbox.pack(fill="both", expand=True, padx=15, pady=(0, 15))
        
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        # 6. STATUS BAR
        # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        status_frame = ctk.CTkFrame(self, fg_color="transparent")
        status_frame.grid(row=5, column=0, padx=25, pady=(5, 15), sticky="ew")
        status_frame.grid_columnconfigure(0, weight=1)
        
        self.status_label = ctk.CTkLabel(
            status_frame,
            text="‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô",
            font=self.FONT_SMALL,
            text_color="#666666"
        )
        self.status_label.pack(side="left")
        
        self.toggle_log_btn = ctk.CTkButton(
            status_frame,
            text="üìù ‡πÅ‡∏™‡∏î‡∏á Log",
            command=self._toggle_log,
            height=28,
            width=100,
            font=self.FONT_SMALL,
            fg_color="transparent",
            hover_color="#374151",
            border_width=1,
            corner_radius=6
        )
        self.toggle_log_btn.pack(side="right")
    
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # STARTUP SEQUENCE
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    def _startup_sequence(self) -> None:
        """Application startup sequence."""
        self._update_path_display()
        
        # First run: must select path
        if SettingsManager.is_first_run() or not self.output_dir:
            self.log("üÜï ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡πÅ‡∏£‡∏Å - ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå", "INFO")
            FirstRunPathDialog(
                self,
                self.font_family,
                self.is_custom_font,
                self._on_path_selected
            )
            return
        
        # Check dependencies
        self._check_dependencies()
    
    def _on_path_selected(self, path: str) -> None:
        """Callback after path selection."""
        self.output_dir = path
        self._path_is_saved = True
        self.save_default_var.set(True)
        self._update_path_display()
        self.log(f"‚úÖ ‡∏ï‡∏±‡πâ‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå: {path}", "SUCCESS")
        self._check_dependencies()
    
    def _check_dependencies(self) -> None:
        """Check if dependencies are installed."""
        if not os.path.exists(YTDLP_PATH) or not os.path.exists(FFMPEG_PATH):
            self.log("‚ö†Ô∏è ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏£‡∏∞‡∏ö‡∏ö...", "WARNING")
            DependencySetupDialog(
                self,
                self.font_family,
                self.is_custom_font,
                self._on_deps_complete
            )
        else:
            self.log("‚úÖ ‡∏£‡∏∞‡∏ö‡∏ö‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ó‡∏≥‡∏á‡∏≤‡∏ô", "SUCCESS")
    
    def _on_deps_complete(self, success: bool) -> None:
        """Callback after dependency installation."""
        if success:
            self.log("üéâ ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!", "SUCCESS")
        else:
            self.log("‚ùå ‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", "ERROR")
    
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # PATH MANAGEMENT
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    def _update_path_display(self) -> None:
        """Update the path display entry."""
        self.path_display.configure(state="normal")
        self.path_display.delete(0, "end")
        self.path_display.insert(0, self.output_dir or "(‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å)")
        self.path_display.configure(state="readonly")
    
    def _browse_folder(self) -> None:
        """Open folder selection dialog."""
        folder = filedialog.askdirectory(
            title="‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏õ‡∏•‡∏≤‡∏¢‡∏ó‡∏≤‡∏á",
            initialdir=self.output_dir or os.path.expanduser("~")
        )
        if folder:
            self.output_dir = folder
            self._update_path_display()
            self.log(f"üìÇ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå: {folder}", "INFO")
            
            if self.save_default_var.get():
                SettingsManager.save_path(folder)
                self.log("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß", "SUCCESS")
    
    def _on_save_checkbox_toggle(self) -> None:
        """Handle save checkbox state change."""
        if self.save_default_var.get():
            if self.output_dir:
                SettingsManager.save_path(self.output_dir)
                self._path_is_saved = True
                self.log("üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡πÅ‡∏•‡πâ‡∏ß", "SUCCESS")
            else:
                self.log("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô", "WARNING")
                self.save_default_var.set(False)
        else:
            SettingsManager.clear_path()
            self._path_is_saved = False
            self.log("üîÑ ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏£‡∏≠‡∏ö‡∏ô‡∏µ‡πâ (‡πÑ‡∏°‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)", "INFO")
    
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # UI STATE MANAGEMENT
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    def _show_progress(self) -> None:
        """Show the progress bar."""
        def _show():
            self.progress_frame.grid(row=3, column=0, padx=25, pady=10, sticky="ew")
            self.progress_bar.set(0)
        self.after(0, _show)
    
    def _hide_progress(self, delay_ms: int = 2000) -> None:
        """Hide the progress bar after delay."""
        def _hide():
            self.progress_frame.grid_forget()
            self.progress_bar.set(0)
            self.progress_pct.configure(text="")
        self.after(delay_ms, _hide)
    
    def _toggle_log(self) -> None:
        """Toggle log visibility."""
        if self.log_visible:
            self.log_container.grid_forget()
            self.toggle_log_btn.configure(text="üìù ‡πÅ‡∏™‡∏î‡∏á Log")
            self.geometry("780x550")
            self.log_visible = False
        else:
            self.log_container.grid(row=4, column=0, padx=25, pady=(0, 10), sticky="nsew")
            self.toggle_log_btn.configure(text="üìù ‡∏ã‡πà‡∏≠‡∏ô Log")
            self.geometry("780x700")
            self.log_visible = True
    
    def log(self, message: str, level: str = "INFO") -> None:
        """Add a log message."""
        timestamp = datetime.now().strftime("%H:%M:%S")
        prefix = {
            "INFO": "‚ÑπÔ∏è",
            "SUCCESS": "‚úÖ",
            "WARNING": "‚ö†Ô∏è",
            "ERROR": "‚ùå"
        }.get(level, "‚Ä¢")
        formatted = f"[{timestamp}] {prefix} {message}\n"
        
        def _update():
            self.log_textbox.insert("end", formatted)
            self.log_textbox.see("end")
        self.after(0, _update)
    
    def update_progress(self, label: str, percentage: Optional[float] = None) -> None:
        """Update progress display (thread-safe)."""
        def _update():
            self.progress_label.configure(text=label)
            if percentage is not None:
                self.progress_bar.set(percentage / 100.0)
                self.progress_pct.configure(text=f"{percentage:.1f}%")
            else:
                self.progress_pct.configure(text="")
        self.after(0, _update)
    
    def set_buttons_state(self, busy: bool = False) -> None:
        """Set button states based on busy status."""
        def _update():
            state = "disabled" if busy else "normal"
            self.download_btn.configure(state=state)
            self.update_btn.configure(state=state)
            self.stop_btn.configure(state="normal" if busy else "disabled")
        self.after(0, _update)
    
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # EVENT HANDLERS
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    def _on_download(self) -> None:
        """Handle download button click."""
        url = self.url_entry.get().strip()
        if not url:
            messagebox.showwarning("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏•‡∏¥‡∏á‡∏Å‡πå", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á URL")
            return
        if not self.output_dir:
            messagebox.showwarning("‡πÑ‡∏°‡πà‡∏û‡∏ö‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Å‡πà‡∏≠‡∏ô")
            return
        if not os.path.exists(YTDLP_PATH):
            messagebox.showerror("‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏∞‡∏ö‡∏ö", "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏î '‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï'")
            return
        
        self.is_downloading = True
        self.set_buttons_state(busy=True)
        self._show_progress()
        self._start_download(url)
    
    def _on_update(self) -> None:
        """Handle update button click."""
        if messagebox.askyesno("‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï?", "‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î yt-dlp ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î?"):
            self.is_updating = True
            self.set_buttons_state(busy=True)
            self._show_progress()
            self._start_update()
    
    def _on_stop(self) -> None:
        """Handle stop button click."""
        if self.downloader:
            self.downloader.cancel()
            self.log("‚èπÔ∏è ‡∏´‡∏¢‡∏∏‡∏î...", "WARNING")
        
        self.is_downloading = False
        self.is_updating = False
        self.set_buttons_state(busy=False)
        self.update_progress("‡∏´‡∏¢‡∏∏‡∏î‡πÅ‡∏•‡πâ‡∏ß", 0)
        self._hide_progress(1000)
    
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    # DOWNLOAD LOGIC (Using Optimized Downloader)
    # ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    
    @run_in_thread
    def _start_download(self, url: str) -> None:
        """Start download in background thread."""
        try:
            # Create optimized downloader with callbacks
            self.downloader = Downloader(
                output_dir=self.output_dir,
                progress_callback=self.update_progress,
                log_callback=self.log,
                concurrent_fragments=4,  # üöÄ Parallel downloads
                use_aria2c=False  # Set to True if user has aria2c
            )
            
            result = self.downloader.download(url)
            
            if result.success:
                self.after(0, lambda: messagebox.showinfo("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", "‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!"))
            else:
                self.after(0, lambda: messagebox.showerror("‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", result.message))
            
            self._hide_progress()
            
        except Exception as e:
            self.log(f"‚ùå Error: {str(e)}", "ERROR")
            self.update_progress("‚ùå Error", 0)
            self._hide_progress()
        finally:
            self.is_downloading = False
            self.downloader = None
            self.set_buttons_state(busy=False)
    
    @run_in_thread
    def _start_update(self) -> None:
        """Start update routine in background thread."""
        try:
            # Detect running mode
            if is_frozen():
                app_path = sys.executable
                skip_app_update = False
                self.log("üè≠ Production Mode: Running as compiled .exe", "INFO")
            else:
                app_path = os.path.join(BASE_DIR, "main.exe")
                skip_app_update = True
                self.log("‚îÅ" * 50, "INFO")
                self.log("üõ†Ô∏è DEV MODE: Skipping App Self-Update", "WARNING")
                self.log("   ‚Ä¢ ‡∏£‡∏±‡∏ô‡∏à‡∏≤‡∏Å‡∏ã‡∏≠‡∏£‡πå‡∏™‡πÇ‡∏Ñ‡πâ‡∏î .py", "INFO")
                self.log("   ‚Ä¢ ‡∏à‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏â‡∏û‡∏≤‡∏∞ yt-dlp ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô", "INFO")
                self.log("‚îÅ" * 50, "INFO")
                import time
                time.sleep(1)
            
            self.log(f"üìå App Version: {APP_VERSION}", "INFO")
            
            result = run_full_update_routine(
                app_version=APP_VERSION,
                app_version_url=UPDATE_JSON_URL,
                app_path=app_path,
                engine_dir=ENGINE_DIR,
                progress_callback=self.update_progress,
                log_callback=self.log,
                skip_app_update=skip_app_update
            )
            
            if result.requires_restart:
                self.log("üîÑ ‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥...", "SUCCESS")
                self.after(0, lambda: messagebox.showinfo(
                    "‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï",
                    "‡πÇ‡∏õ‡∏£‡πÅ‡∏Å‡∏£‡∏°‡∏à‡∏∞‡∏õ‡∏¥‡∏î‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà"
                ))
                self.after(1500, lambda: sys.exit(0))
                return
            
            if result.success:
                self.after(0, lambda: messagebox.showinfo("‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à", result.message))
            else:
                self.after(0, lambda: messagebox.showwarning("‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô", result.message))
            
            self._hide_progress()
            
        except Exception as e:
            self.log(f"‚ùå ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: {str(e)}", "ERROR")
            self.update_progress("‚ùå ‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß", 0)
            self._hide_progress()
        finally:
            self.is_updating = False
            self.set_buttons_state(busy=False)
